{"version":3,"sources":["src/chat.js"],"names":["$","document","ready","formatDate","getPrettyDate","date","day","getHours","min","getMinutes","createMessage","str","message","createElement","addClass","innerHTML","find","attr","i","src","decodeURIComponent","createHeader","name","header","sender","text","time","appendChild","window","FTW","Error","chat","ignoreList","Set","previousSender","appendMessage","addMessageToChat","msg","user","from","type","has","isNewSender","gutter","pfp","jdenticon","update","container","body","Date","append","safeAppend","scrollDiff","prop","height","stop","tempInput","autocomplete","source","request","response","match","term","test","emojies","filter","emoji","startsWith","slice","map","label","value","position","my","at","collision","open","$labels","children","html","innerText","outerHTML","select","event","ui","val","replace","item","stopPropagation","preventDefault","focus","keypress","e","which","trim","charAt","cmd","exec","substring","socket","emit"],"mappings":"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","file":"chat.js","sourcesContent":["/* eslint-env browser, jquery */\r\n/* globals jdenticon, emojies */\r\n$(document).ready(() => {\r\n  const formatDate = function getPrettyDate(date) {\r\n    const day = date.getHours();\r\n    let min = date.getMinutes();\r\n\r\n    if (min < 10) {\r\n      min = `0${min}`;\r\n    }\r\n\r\n    return `${day}:${min}`;\r\n  };\r\n\r\n  const createMessage = (str) => {\r\n    const message = document.createElement('div');\r\n    $(message).addClass('chat-message');\r\n\r\n    message.innerHTML = str;\r\n\r\n    // Fix +1 emoji\r\n    $(message).find('img.emoji').attr('src', (i, src) => decodeURIComponent(src));\r\n\r\n    return message;\r\n  };\r\n\r\n  const createHeader = (name, date) => {\r\n    const header = document.createElement('div');\r\n    $(header).addClass('chat-header');\r\n\r\n    const sender = document.createElement('span');\r\n    $(sender).addClass('chat-message-sender');\r\n    $(sender).text(name);\r\n    const time = document.createElement('span');\r\n    $(time).addClass('chat-message-timestamp');\r\n    $(time).text(formatDate(date));\r\n\r\n    header.appendChild(sender);\r\n    header.appendChild(time);\r\n    return header;\r\n  };\r\n\r\n  if (!window.FTW) {\r\n    throw new Error('FTW object not loaded');\r\n  }\r\n\r\n  if (!window.FTW.chat) {\r\n    const chat = {};\r\n\r\n    chat.ignoreList = new Set();\r\n\r\n    chat.previousSender = '';\r\n\r\n    chat.appendMessage = function addMessageToChat(msg) {\r\n      const user = msg.from;\r\n      const str = msg.message;\r\n      const { type } = msg;\r\n\r\n      if (this.ignoreList.has(user)) {\r\n        return;\r\n      }\r\n\r\n      const isNewSender = user !== chat.previousSender;\r\n\r\n      const message = document.createElement('div');\r\n      $(message).addClass('chat-item');\r\n\r\n      if (type === 'private') {\r\n        $(message).addClass('chat-pm');\r\n      }\r\n\r\n\r\n      const gutter = document.createElement('span');\r\n      $(gutter).addClass('chat-message-gutter');\r\n\r\n      if (isNewSender) {\r\n        const pfp = document.createElement('canvas');\r\n        $(pfp).addClass('pfp');\r\n        $(pfp).attr('data-jdenticon-value', user);\r\n        $(pfp).attr('width', '50');\r\n        $(pfp).attr('height', '50');\r\n        jdenticon.update(pfp);\r\n\r\n        const container = document.createElement('div');\r\n        $(container).addClass('image-container');\r\n\r\n\r\n        container.appendChild(pfp);\r\n        gutter.appendChild(container);\r\n      }\r\n\r\n      message.appendChild(gutter);\r\n\r\n      const body = document.createElement('span');\r\n      $(body).addClass('chat-message-body');\r\n\r\n      if (isNewSender) {\r\n        body.appendChild(createHeader(user, new Date()));\r\n      }\r\n\r\n      body.appendChild(createMessage(str));\r\n\r\n      message.appendChild(body);\r\n\r\n      $('#chat-display').append(message);\r\n\r\n      chat.previousSender = user;\r\n    };\r\n\r\n    chat.safeAppend = (msg) => {\r\n      const scrollDiff = $('#chat-display').prop('scrollHeight')\r\n        - $('#chat-display').prop('scrollTop')\r\n        - $('#chat-display').height();\r\n\r\n      window.FTW.chat.appendMessage(msg);\r\n\r\n      $('#chat-display').stop(true, true);\r\n\r\n      if (scrollDiff < 10) {\r\n        $('#chat-display').prop('scrollTop', $('#chat-display').prop('scrollHeight'));\r\n      }\r\n    };\r\n\r\n    // Emoji auto-complete\r\n    let tempInput = '';\r\n\r\n    $('#chat-box').autocomplete({\r\n      source(request, response) {\r\n        const match = request.term.match(/:([a-z0-9+\\-_]*?)$/);\r\n\r\n        if (match && !/:([a-z0-9+\\-_]*?):$/.test(request.term)) {\r\n          response(emojies\r\n            .filter(emoji => emoji.startsWith(match[1]))\r\n            .slice(0, 5)\r\n            // eslint-disable-next-line arrow-body-style\r\n            .map((emoji) => {\r\n              return {\r\n                label: `:${emoji}:`,\r\n                value: emoji,\r\n              };\r\n            }));\r\n\r\n          tempInput = request.term;\r\n        } else {\r\n          response([]);\r\n        }\r\n      },\r\n\r\n      position: { my: 'left bottom', at: 'left top', collision: 'flip' },\r\n\r\n      open() {\r\n        const $labels = $('#chat-box').autocomplete('widget').children().children();\r\n\r\n        $labels.html((i, html) => {\r\n          const emoji = $labels[i].innerText.match(/^:(.*):$/)[1];\r\n\r\n          return `${$('<img />')\r\n            .addClass('emoji')\r\n            .attr('src', `/emoji/${emoji}.png`)\r\n            .attr('title', emoji)\r\n            .attr('alt', `:${emoji}:`)[0].outerHTML} ${html}`;\r\n        });\r\n      },\r\n\r\n      select(event, ui) {\r\n        $('#chat-box').val(tempInput.replace(/:([a-z0-9+\\-_]*?)$/, `:${ui.item.value}:`));\r\n\r\n        event.stopPropagation();\r\n        event.preventDefault();\r\n      },\r\n\r\n      focus(event, ui) {\r\n        $('#chat-box').val(tempInput.replace(/:([a-z0-9+\\-_]*?)$/, `:${ui.item.value}:`));\r\n\r\n        event.stopPropagation();\r\n        event.preventDefault();\r\n      },\r\n    });\r\n\r\n    $('#chat-box').keypress((e) => {\r\n      if (e.which === 13) {\r\n        let message = $('#chat-box').val();\r\n        message = message.trim();\r\n\r\n        if (message !== '') {\r\n          if (message.charAt(0) === '/') {\r\n            window.FTW.cmd.exec(message.substring(1));\r\n          } else {\r\n            window.FTW.socket.emit('public message', message);\r\n          }\r\n        }\r\n\r\n        $('#chat-box').val('');\r\n      }\r\n    });\r\n\r\n    window.FTW.chat = chat;\r\n  }\r\n});\r\n"]}